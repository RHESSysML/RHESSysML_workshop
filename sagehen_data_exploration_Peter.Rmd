---
title: "Sagehen Data Exploration"
author: "Peter Menzies"
date: "1/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(randomForest)
library(randomForestExplainer)
```

```{r}
df <- read_csv(here("data", "sageres.csv"))
```

```{r}
print(nrow(df))
print(ncol(df))

print(names(df))
```


```{r}
head(df)
```


```{r}
(unique(df$stratumID))
(unique(df$patchID))
(unique(df$zoneID))
```

```{r}
unique(df$month)
```


```{r}
df_apr <- df %>% 
  filter(month == 4, year == 2020)
```

```{r}
df_by_wy <- df %>% 
  group_by(wy, stratumID, clim, scen) %>% 
  summarise_if(is.numeric, mean) %>% 
  select(-day, -month, -year, -basinID, -hillID, -zoneID, -patchID)
```

```{r}
df_by_wy <- df_by_wy %>% 
  mutate(water_efficiency = npp / trans)
```

```{r}
df_wy_0 <- df_by_wy %>% 
  filter(clim == 0)

df_wy_2 <- df_by_wy %>% 
  filter(clim == 2)
```


```{r}
ggplot(df_wy_0, aes(x = rz_storage, y = water_efficiency)) +
  geom_point() + 
  geom_smooth(method = "lm")

ggplot(df_wy_2, aes(x = rz_storage, y = water_efficiency)) +
  geom_point() + 
  geom_smooth(method = "lm")
```

```{r}
ggplot(df_wy_0, aes(x = tmax, y = water_efficiency)) +
  geom_point() + 
  geom_smooth()

ggplot(df_wy_2, aes(x = tmax, y = water_efficiency)) +
  geom_point() + 
  geom_smooth()
```
## Random Forest Exploration

Comparing node purity increase among variables explaining npp

```{r}
rf <- randomForest(formula = npp ~ tmax  + tmin + aspect + slope + clim + swe + scen + elev + precip,     
                 data = df_by_wy, localImp = TRUE)

rf_imp <- rf$importance %>%
  as.data.frame() %>%
  rownames_to_column("variable")
```

*IncNodePurity* (increase in node purity) the total decrease in node impurities, measured by the Gini Index


```{r}
rf_clim0 <- randomForest(formula = npp ~ tmax + tmin + aspect + slope + swe + scen + elev + precip,     
                 data = df_wy_0, localImp = TRUE)

rf_imp_clim0 <- rf_clim0$importance %>%
  as.data.frame() %>%
  rownames_to_column("variable")
```



```{r}
rf_clim2 <- randomForest(formula = npp ~ tmax + tmin + aspect + slope + swe + scen + elev + precip,     
                 data = df_wy_2, localImp = TRUE)

rf_imp_clim2 <- rf_clim2$importance %>%
  as.data.frame() %>%
  rownames_to_column("variable")
```

## `randomForestExplainer`

The function below spits out a knitted html of its own that contains a whole slew of summary visualizations describing the `randomForest` output

```{r}
#randomForestExplainer::explain_forest(rf_clim0)
```


```{r}
mindep <- min_depth_distribution(rf)
```


```{r}
mindep_avg <- mindep %>% 
  group_by(variable) %>% 
  summarize(mean_min_depth = mean(minimal_depth))
```


```{r}

```











